<!DOCTYPE html>
<html lan="en">
	<head>
		<title>L1G2L1T GCP</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script src="jquery.zoom.min.js"></script>
		<script src="imgs.js"></script>
        <script src="imgInfo.js"></script>
		<script src="imagesLoaded.js"></script>		
		<style>
			#imgContainer{
				margin:50px 0px 0px 20px
			}
			.imgholder{
				display:inline-block;
			}

			td{border: 1px solid black;}
			
			table{
				position:absolute;
				pointer-events: none;
				border-collapse: collapse;
				border-spacing: 0;
			}
			.svgDiv{
				position:absolute;
				pointer-events: none;
				z-index: 10;
			}
			circle{
				z-index: 12;
			}

		</style>
				
	</head>

	<body>
		<div id="imgContainer">
			<div class="imgholder">
				<p>Reference Image:</p>
				<div id="refImgDiv" class="imgDiv"></div>
			</div>
			<div class="imgholder">
				<p>Fix Image:</p>
				<div id="fixImgDiv" class="imgDiv"></div>
			</div>
		</div>
		<table id="refImgGrid" style="display:none">
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
		</table>
		<table id="fixImgGrid" style="display:none">
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
			<tr>
				<td></td><td></td><td></td><td></td>
			</tr>
		</table>
		<div id="refSvgDiv" class="svgDiv">
			<svg id="refSvg"></svg>
		</div>
		<div id="fixSvgDiv" class="svgDiv">
			<svg id="fixSvg"></svg>
		</div>	
<!-- 		<button id="download" type="button" class="btn btn-default disabled" style="margin-left:20px">Download Tie Points</button>
 -->		<a href="" class="btn btn-default disabled" role="button" style="margin-left:20px">Download Tie Points</a>
		<script>
			
			
			var color = ["#3396fb","#ffd700","#00ff83"]
			var current = 0;
			var point = 0;
			var itpInfo = [];
			
			function setPosition(refDiv, setObj, type){
				var obj = $('#'+refDiv)
				var refHeight = obj[0].getBoundingClientRect().height;
				var refWidth = obj[0].getBoundingClientRect().width;
				var refOffset = obj.offset()
				if(type == "table"){
					$('#'+setObj).height(refHeight).width(refWidth).css({"top":refOffset.top,"left":refOffset.left});
					//$('#'+setObj).height(refHeight-1).width(refWidth-1).css({"top":refOffset.top,"left":refOffset.left});
				} else if(type == "div"){
					$('#'+setObj).height(refHeight).width(refWidth).css({"top":refOffset.top,"left":refOffset.left});
					if (setObj.indexOf("ref") >= 0){$("#refSvg").attr({"height":refHeight, "width":refWidth})} else
					if (setObj.indexOf("fix") >= 0){$("#fixSvg").attr({"height":refHeight, "width":refWidth})}
				}
				
			}
						
			function loadImg(imgSrc, type){
				var imgDiv = "refImgDiv";
				var imgGrid = "refImgGrid";
				var svgDiv = "refSvgDiv";
				if(type == "fix"){
					imgDiv = "fixImgDiv";
					imgGrid = "fixImgGrid";
					svgDiv = "fixSvgDiv";
				}
								
				$("#"+imgDiv).append('<img class="zoomImg" src='+imgSrc+' width=600px height=auto>')
				.zoom({url:imgSrc, magnify:1.5})
				.imagesLoaded(function(){
					setPosition(imgDiv, imgGrid, "table");
					setPosition(imgDiv, svgDiv, "div");
					$("#"+imgGrid).show();
				});	
			}
			
			function makeSVG(tag, attrs) {
				var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
				for (var k in attrs)
					el.setAttribute(k, attrs[k]);
				return el;
			}
			
			function appendCircle(el, e){
				var parentOffset = el.offset();
				var relX = e.pageX - parentOffset.left;
				var relY = e.pageY - parentOffset.top;
				var circle = makeSVG("circle", {cx:relX, cy:relY, r:5, fill:color[point]});
				
				if (el.context.id.indexOf("ref") >= 0){
					if(itpInfo[current].ref.point[point].row == 0){
						document.getElementById("refSvg").appendChild(circle);						
						var row = relY * (itpInfo[current].ref.origSize.rows/itpInfo[current].ref.smallSize.rows);
						var col = relX * (itpInfo[current].ref.origSize.cols/itpInfo[current].ref.smallSize.cols);
						itpInfo[current].ref.point[point].row = row;
						itpInfo[current].ref.point[point].col = col;
						console.log(relY)
						console.log(itpInfo[current].ref.origSize.rows)
						console.log(itpInfo[current].ref.smallSize.rows)
						console.log(row)	
					} else if(itpInfo[current].fix.point[point].row == 0){
						alert('Please identify a corresponding point in the "Fix Image"')
					}
					
					
				} else if (el.context.id.indexOf("fix") >= 0){
					if(itpInfo[current].fix.point[point].row == 0){
						document.getElementById("fixSvg").appendChild(circle);
						var row = relY * (itpInfo[current].fix.origSize.rows/itpInfo[current].fix.smallSize.rows);
						var col = relX * (itpInfo[current].fix.origSize.cols/itpInfo[current].fix.smallSize.cols);
						itpInfo[current].fix.point[point].row = row;
						itpInfo[current].fix.point[point].col = col;
					} else if(itpInfo[current].ref.point[point].row == 0){
						alert('Please identify a corresponding point in the "Reference Image"')
					} 
				}
				
				if(itpInfo[current].fix.point[point].row != 0 && itpInfo[current].ref.point[point].row != 0){point += 1}
				if(point == 3){
					point = 0
					current =+ 1
					$(".imgDiv").empty();
					$("svg").empty();
					//if(current == info.fixInfo.imgFile.length - 1){

					//} else{

						loadImg(info.refInfo.imgFile, "ref");
						loadImg(info.fixInfo.imgFile[current], "fix");
					
					//}
				}
				

			}
			
			
			
			$(window).load(function(){
				loadImg(info.refInfo.imgFile, "ref");
				loadImg(info.fixInfo.imgFile[current], "fix");
				createItpInfo();
			})
			
			$(".imgDiv").click(function(e){
				appendCircle($(this), e, point)
			});
			

			
			function createItpInfo(){						
				info.fixInfo.imgFile.forEach(function(e, i){
					itpInfo.push({"ref":{"file":"","point":[],"origSize":{"rows":0,"cols":0},"medSize":{"rows":0,"cols":0},"smallSize":{"rows":0,"cols":0}}, "fix":{"file":"","point":[],"origSize":{"rows":0,"cols":0},"medSize":{"rows":0,"cols":0},"smallSize":{"rows":0,"cols":0}}, "process":0, "note":""});
					//move some info from the R json output to the the js json output 
					//reference file info
					itpInfo[i].ref.file = info.refInfo.origFile;		
					itpInfo[i].ref.origSize.rows = info.refInfo.origRows
					itpInfo[i].ref.origSize.cols = info.refInfo.origCols
					itpInfo[i].ref.medSize.rows = info.refInfo.imgRows
					itpInfo[i].ref.medSize.cols = info.refInfo.imgCols
					itpInfo[i].ref.smallSize.rows = info.refInfo.imgRows * (600/info.refInfo.imgCols)
					itpInfo[i].ref.smallSize.cols = 600
								
					//fix files info
					itpInfo[i].fix.file = info.fixInfo.origFile[i];
					itpInfo[i].fix.origSize.rows = info.fixInfo.origRows[i]
					itpInfo[i].fix.origSize.cols = info.fixInfo.origCols[i]
					itpInfo[i].fix.medSize.rows = info.fixInfo.imgRows[i]
					itpInfo[i].fix.medSize.cols = info.fixInfo.imgCols[i]
					itpInfo[i].fix.smallSize.rows = info.fixInfo.imgRows[i] * (600/info.fixInfo.imgCols[i])
					itpInfo[i].fix.smallSize.cols = 600
					console.log(itpInfo)
					//push 3 point row and col objects
					for(p=0;p<3;p++){
						itpInfo[i].ref.point.push({"row":0,"col":0});
						itpInfo[i].fix.point.push({"row":0,"col":0});
					}
				});
			}
			
			
		</script>
	
	</body>
</html>